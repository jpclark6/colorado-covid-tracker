AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  colorado-covid-tracker

  Sample SAM Template for colorado-covid-tracker
Parameters: 
  NotificationEmail:
    Type: String
  DbCredentials:
    Type: 'AWS::SSM::Parameter::Value<String>'
    Description: Database creds in the format postgres://<user>:<pw>@<host>/<db>
    Default: /colorado-covid/db_creds
Globals:
  Function:
    Timeout: 6
    Environment:
      Variables:
        S3_BUCKET: !Ref S3Bucket

Resources:
  CoCovidFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: src/api/
      Handler: app.app
      Runtime: python3.8
      Policies:
        - AmazonS3FullAccess
        - AmazonSSMReadOnlyAccess
      Environment:
        Variables:
          DB_CREDENTIALS: !Ref DbCredentials
      Events:
        AllData:
          Type: Api
          Properties:
            Path: /data/
            Method: get
          Auth:
            UsagePlan:
              CreateUsagePlan: PER_API
              Description: Usage plan for this API
              Quota:
                Limit: 500
                Period: MONTH
              Throttle:
                BurstLimit: 100
                RateLimit: 50
              Tags:
                - Key: TagName
                  Value: TagValue
  
  RawDailyFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/etl/
      Handler: extract.handler
      Runtime: python3.8
      Policies:
        - AmazonS3FullAccess
        - AWSLambdaFullAccess
      Environment:
        Variables:
          NEXT_FUNCTION: !Ref TransformDailyFunction
      Events:
        EEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0 1 * * ? *)

  TransformDailyFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/etl/
      Handler: transform.handler
      Runtime: python3.8
      Policies:
        - AmazonS3FullAccess
        - AmazonSSMReadOnlyAccess
        - AWSLambdaFullAccess
      Environment:
        Variables:
          NEXT_FUNCTION: !Ref LoadDailyFunction

  LoadDailyFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/etl/
      Handler: load.handler
      Runtime: python3.8
      Policies:
      - AmazonS3FullAccess
      - AmazonSSMReadOnlyAccess
      Environment:
        Variables:
          DB_CREDENTIALS: !Ref DbCredentials

  AlarmTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
      - Protocol: email
        Endpoint: !Ref NotificationEmail

  Alarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
        - !Ref AlarmTopic
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: APIFunction
          Value: !Ref CoCovidFunction
        - Name: RawLambdaFunction
          Value: !Ref RawDailyFunction
        - Name: TransormLambdaFunction
          Value: !Ref TransformDailyFunction
        - Name: LoadLambdaFunction
          Value: !Ref LoadDailyFunction
      EvaluationPeriods: 1
      MetricName: Errors
      Namespace: AWS/Lambda
      Period: 60
      Statistic: Sum
      Threshold: '1'

  S3Bucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    

Outputs:
  CoCovidApiData:
    Description: "API Gateway endpoint URL for Prod stage for Colorado Covid function"
    Value: !Sub "https://${CoCovidFunction}.execute-api.${AWS::Region}.amazonaws.com/Prod/data/"
  CoCovidBucket:
    Description: "Bucket used to store stack"
    Value: !Ref S3Bucket
